<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Severe Weather Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f0f2f5;
        }
        header {
            background: linear-gradient(to right, #2c3e50, #4a6491);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .logo i {
            font-size: 1.8rem;
        }
        .address-form {
            display: flex;
            gap: 0.5rem;
        }
        .address-input {
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            width: 250px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .alert-banner {
            background-color: #e74c3c;
            color: white;
            padding: 0.8rem;
            text-align: center;
            display: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1000;
        }
        .alert-banner.active {
            display: block;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        .map-container {
            flex: 1;
            position: relative;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .info-panel {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 300px;
            display: none;
        }
        .info-panel h3 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        .info-panel p {
            margin: 0.3rem 0;
            color: #34495e;
        }
        .legend {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
        }
        .legend h3 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 0.3rem 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 0.5rem;
            border-radius: 3px;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
        }
        .refresh-info {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 1000;
        }
        .filter-panel {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 200px;
        }
        .filter-panel h3 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        .filter-checkbox {
            margin: 0.3rem 0;
        }
        .progress-bar {
            position: absolute;
            bottom: 3.5rem;
            left: 1rem;
            width: 200px;
            height: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
            z-index: 1000;
        }
        .progress {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.3s;
        }
        .api-status {
            position: absolute;
            bottom: 5rem;
            left: 1rem;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            z-index: 1000;
        }
        .view-toggle {
            position: absolute;
            top: 1rem;
            left: 16.5rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            z-index: 1001;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .view-toggle label {
            font-weight: 500;
            color: #2c3e50;
        }
        .view-toggle select {
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <i>üå™Ô∏è</i>
            <h1>Severe Weather Tracker</h1>
        </div>
        <div class="address-form">
            <input type="text" class="address-input" placeholder="Enter your address" id="address-input">
            <button id="save-address">Save Location</button>
        </div>
    </header>
    <div class="alert-banner" id="alert-banner"></div>
    <div class="map-container">
        <div id="map"></div>
        <div class="info-panel" id="info-panel"></div>
        <div class="filter-panel">
            <h3>Filter Alerts</h3>
            <div id="alert-filters"></div>
        </div>
        <div class="view-toggle">
            <label for="view-mode">View Mode:</label>
            <select id="view-mode">
                <option value="polygon" selected>Polygon</option>
                <option value="county">Active County</option>
            </select>
        </div>
        <div class="legend">
            <h3>Legend</h3>
            <div id="legend-items"></div>
        </div>
        <div class="refresh-info">
            Data refreshes every minute. Last updated: <span id="last-updated">-</span>
        </div>
        <div class="progress-bar">
            <div class="progress" id="progress-bar"></div>
        </div>
        <div class="api-status" id="api-status">
            Geoapify requests today: <span id="geoapify-count">0</span>/3000
        </div>
        <div class="loading" id="loading">
            Loading weather data...
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <script>
        const map = L.map('map').setView([39.8283, -98.5795], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let alertLayers = {};
        let userMarker = null;
        let userLocation = null;
        let alertTypes = {};
        let countyGeojson = null;
        let geoapifyRequestCount = 0;
        let allAlerts = [];
        let polygonMode = true;

        const alertStyles = {
            'Tornado Warning': { color: '#ff0000', className: 'pulsing-layer' },
            'Tornado Watch': { color: '#ffcc00', dashArray: '10, 10', fillOpacity: 0.3 },
            'Tornado Emergency': { color: '#cc00ff', className: 'pulsing-layer' },
            'Flash Flood Warning': { color: '#880000', className: 'pulsing-layer' },
            'Flood Advisory': { color: '#ffff00', dashArray: '10, 10', fillOpacity: 0.3 },
            'Flood Watch': { color: '#aaff00', dashArray: '10, 10', fillOpacity: 0.3 },
            'Flood Warning': { color: '#007700', className: 'pulsing-layer' },
            'Coastal Flood Advisory': { color: '#77aaff', dashArray: '10, 10', fillOpacity: 0.3 },
            'Coastal Flood Warning': { color: '#0055ff', className: 'pulsing-layer' },
            'Coastal Flood Statement': { color: '#aaccff', dashArray: '5, 5', fillOpacity: 0.2 },
            'Severe Thunderstorm Warning': { color: '#ff0000', dashArray: '10, 10', className: 'pulsing-layer' },
            'Severe Thunderstorm Watch': { color: '#ffcc00', fillOpacity: 0.3 },
            'Special Weather Statement': { color: '#cccccc', dashArray: '5, 5', fillOpacity: 0.2 },
            'Winter Storm Warning': { color: '#00aaff', className: 'pulsing-layer' },
            'Winter Storm Watch': { color: '#00ccff', dashArray: '10, 10', fillOpacity: 0.3 },
            'Winter Weather Advisory': { color: '#00ffff', dashArray: '5, 5', fillOpacity: 0.3 },
            'Blizzard Warning': { color: '#ffffff', className: 'pulsing-layer' },
            'Wind Advisory': { color: '#ffaa00', dashArray: '5, 5', fillOpacity: 0.3 },
            'High Wind Warning': { color: '#ff7700', className: 'pulsing-layer' },
            'Gale Warning': { color: '#0077ff', dashArray: '10, 10', fillOpacity: 0.3 },
            'Gale Watch': { color: '#0055cc', dashArray: '10, 10', fillOpacity: 0.3 },
            'Small Craft Advisory': { color: '#5555ff', dashArray: '5, 5', fillOpacity: 0.3 },
            'Marine Weather Statement': { color: '#aaaaff', dashArray: '5, 5', fillOpacity: 0.2 },
            'Tropical Storm Warning': { color: '#00ddcc', className: 'pulsing-layer' },
            'Tropical Storm Watch': { color: '#00ffee', dashArray: '10, 10', fillOpacity: 0.3 },
            'Hurricane Warning': { color: '#ff0000', className: 'pulsing-layer' },
            'Hurricane Watch': { color: '#ff8888', dashArray: '10, 10', fillOpacity: 0.3 },
            'Heat Advisory': { color: '#ff5500', dashArray: '5, 5', fillOpacity: 0.3 },
            'Excessive Heat Warning': { color: '#ff0000', className: 'pulsing-layer' },
            'Dense Fog Advisory': { color: '#aaaaaa', dashArray: '5, 5', fillOpacity: 0.3 },
            'Dense Smoke Advisory': { color: '#666666', dashArray: '5, 5', fillOpacity: 0.3 },
            'Air Quality Alert': { color: '#aa66aa', dashArray: '5, 5', fillOpacity: 0.3 },
            'Rip Current Statement': { color: '#00ccff', dashArray: '5, 5', fillOpacity: 0.3 },
            'Beach Hazards Statement': { color: '#00aacc', dashArray: '5, 5', fillOpacity: 0.3 },
            'Lake Wind Advisory': { color: '#55aaff', dashArray: '5, 5', fillOpacity: 0.3 },
            'Frost Advisory': { color: '#ccffff', dashArray: '5, 5', fillOpacity: 0.3 },
            'Freeze Warning': { color: '#00ffff', className: 'pulsing-layer' },
            'Freeze Watch': { color: '#00cccc', dashArray: '10, 10', fillOpacity: 0.3 },
            'Ashfall Advisory': { color: '#888888', dashArray: '5, 5', fillOpacity: 0.3 },
            'Dust Storm Warning': { color: '#ccaa00', className: 'pulsing-layer' },
            'Dust Storm Advisory': { color: '#ccbb77', dashArray: '5, 5', fillOpacity: 0.3 },
            'Snow Squall Warning': { color: '#ffffff', className: 'pulsing-layer' },
            'Extreme Wind Warning': { color: '#ff00ff', className: 'pulsing-layer' },
            'Special Marine Warning': { color: '#ff5555', className: 'pulsing-layer' },
            '_default': { color: '#5555ff', fillOpacity: 0.3 }
        };

        document.addEventListener('DOMContentLoaded', function() {
            const savedAddress = localStorage.getItem('weatherTrackerAddress');
            if (savedAddress) {
                document.getElementById('address-input').value = savedAddress;
                geocodeAddress(savedAddress);
            }
            document.getElementById('save-address').addEventListener('click', saveAddress);
            const savedCount = localStorage.getItem('geoapifyRequestCount');
            if (savedCount) {
                geoapifyRequestCount = parseInt(savedCount);
                document.getElementById('geoapify-count').textContent = geoapifyRequestCount;
            }
            document.getElementById('view-mode').addEventListener('change', function() {
                polygonMode = this.value === 'polygon';
                renderAlerts();
            });
            loadCountyBoundaries().then(() => fetchWeatherData());
            setInterval(fetchWeatherData, 60000);
        });

        async function loadCountyBoundaries() {
            try {
                const response = await fetch('https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json');
                countyGeojson = await response.json();
                window.countyLookup = {};
                if (countyGeojson && countyGeojson.objects && countyGeojson.objects.counties) {
                    const counties = countyGeojson.objects.counties;
                    const countyFeatures = topojson.feature(countyGeojson, counties).features;
                    countyFeatures.forEach(feature => {
                        if (feature.id) window.countyLookup[feature.id] = feature;
                    });
                }
            } catch (error) {
                console.error('Error loading county boundaries:', error);
            }
        }

        function saveAddress() {
            const address = document.getElementById('address-input').value;
            if (address.trim() !== '') {
                localStorage.setItem('weatherTrackerAddress', address);
                geocodeAddress(address);
            }
        }

        function geocodeAddress(address) {
            document.getElementById('loading').style.display = 'block';
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);
                        userLocation = { lat, lng: lon };
                        map.setView([lat, lon], 9);
                        if (userMarker) map.removeLayer(userMarker);
                        userMarker = L.marker([lat, lon]).addTo(map).bindPopup('Your location').openPopup();
                        checkUserInAlertArea();
                    } else {
                        alert('Address not found. Please try a more specific address.');
                    }
                })
                .catch(error => {
                    console.error('Geocoding error:', error);
                    alert('Error finding address. Please try again.');
                })
                .finally(() => {
                    document.getElementById('loading').style.display = 'none';
                });
        }

        function fetchWeatherData() {
            document.getElementById('loading').style.display = 'block';
            Object.keys(alertLayers).forEach(id => {
                try { map.removeLayer(alertLayers[id]); } catch {}
            });
            alertLayers = {};
            alertTypes = {};
            allAlerts = [];
            document.getElementById('progress-bar').style.width = '0%';

            fetch('https://api.weather.gov/alerts/active')
                .then(r => r.json())
                .then(data => {
                    allAlerts = (data.features || []);
                    if (!allAlerts.length) {
                        document.getElementById('loading').style.display = 'none';
                        return;
                    }
                    renderAlerts();
                    document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
                    document.getElementById('progress-bar').style.width = '100%';
                    document.getElementById('loading').style.display = 'none';
                })
                .catch(e => {
                    console.error('NWS fetch failed:', e);
                    document.getElementById('loading').style.display = 'none';
                });
        }

        function renderAlerts() {
            Object.keys(alertLayers).forEach(id => {
                try { map.removeLayer(alertLayers[id]); } catch {}
            });
            alertLayers = {};
            alertTypes = {};
            allAlerts.forEach(alert => {
                const event = alert.properties.event;
                alertTypes[event] = true;
            });
            updateFiltersAndLegend();
            allAlerts.forEach(alert => {
                processAlertForView(alert);
            });
            if (userLocation) checkUserInAlertArea();
        }

        function processAlertForView(alert) {
            const properties = alert.properties;
            const geometry = alert.geometry;
            const eventType = properties.event;
            const style = getAlertStyle(properties);

            let layer = null;
            let show = true;
            const filterCheckbox = document.getElementById('filter-' + eventType.replace(/\s+/g, '-'));
            if (filterCheckbox && !filterCheckbox.checked) show = false;

            if (polygonMode && geometry && (geometry.type === 'Polygon' || geometry.type === 'MultiPolygon')) {
                if (geometry.type === 'Polygon') {
                    const coordinates = geometry.coordinates[0];
                    const latLngs = coordinates.map(coord => [coord[1], coord[0]]);
                    layer = L.polygon(latLngs, style)
                            .bindPopup(createPopupContent(properties));
                } else if (geometry.type === 'MultiPolygon') {
                    const polygons = geometry.coordinates.map(polygonCoords => {
                        const latLngs = polygonCoords[0].map(coord => [coord[1], coord[0]]);
                        return L.polygon(latLngs, style);
                    });
                    layer = L.featureGroup(polygons).bindPopup(createPopupContent(properties));
                }
            } else if (!polygonMode && properties.geocode && properties.geocode.UGC && window.countyLookup) {
                const ugcCodes = properties.geocode.UGC;
                const countyOutlines = [];
                ugcCodes.forEach(ugcCode => {
                    if (ugcCode.length === 6) {
                        const countyGeometry = findCountyGeometry(ugcCode);
                        if (countyGeometry) {
                            const countyLayer = L.geoJSON(countyGeometry, {
                                style: style,
                                onEachFeature: function(feature, layer) {
                                    layer.bindPopup(createPopupContent(properties));
                                }
                            });
                            countyOutlines.push(countyLayer);
                        }
                    }
                });
                if (countyOutlines.length > 0) layer = L.featureGroup(countyOutlines);
            }
            if (layer && show) {
                addLayerEventListeners(layer, properties);
                alertLayers[properties.id] = layer;
                layer.addTo(map);
            }
        }

        function addLayerEventListeners(layer, properties) {
            layer.on('mouseover', function(e) {
                if (e.layer && e.layer.getLatLng) {
                    showInfoPanel(properties, e.layer.getLatLng());
                } else if (e.latlng) {
                    showInfoPanel(properties, e.latlng);
                }
            });
            layer.on('mouseout', function() {
                hideInfoPanel();
            });
        }

        function findCountyGeometry(ugcCode) {
            if (!ugcCode || !window.countyLookup) return null;
            const stateCode = ugcCode.substring(0, 2);
            const countyCode = ugcCode.substring(2);
            const fipsCode = stateCode + countyCode;
            return window.countyLookup[fipsCode] || null;
        }

        function updateFiltersAndLegend() {
            const filtersContainer = document.getElementById('alert-filters');
            const legendContainer = document.getElementById('legend-items');
            filtersContainer.innerHTML = '';
            legendContainer.innerHTML = '';
            Object.keys(alertTypes).sort().forEach(alertType => {
                const style = getAlertStyle({ event: alertType });
                const filterDiv = document.createElement('div');
                filterDiv.className = 'filter-checkbox';
                filterDiv.innerHTML = `
                    <input type="checkbox" id="filter-${alertType.replace(/\s+/g, '-')}" 
                           checked onchange="toggleAlertType('${alertType}')">
                    <label for="filter-${alertType.replace(/\s+/g, '-')}">${alertType}</label>
                `;
                filtersContainer.appendChild(filterDiv);
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${style.color}; 
                         ${style.dashArray ? `border: 2px dashed ${style.color};` : ''}"></div>
                    <span>${alertType}</span>
                `;
                legendContainer.appendChild(legendItem);
            });
        }

        window.toggleAlertType = function(alertType) {
            renderAlerts();
        }

        function getAlertStyle(properties) {
            const eventType = properties.event;
            const styleConfig = alertStyles[eventType] || alertStyles['_default'];
            return {
                color: styleConfig.color,
                weight: 3,
                opacity: 1,
                fillColor: styleConfig.color,
                fillOpacity: styleConfig.fillOpacity || 0.3,
                dashArray: styleConfig.dashArray,
                className: styleConfig.className
            };
        }

        function createPopupContent(properties) {
            return `
                <div>
                    <h3>${properties.event}</h3>
                    <p><strong>Area:</strong> ${properties.areaDesc}</p>
                    <p><strong>Severity:</strong> ${properties.severity}</p>
                    <p><strong>Effective:</strong> ${new Date(properties.effective).toLocaleString()}</p>
                    <p><strong>Expires:</strong> ${new Date(properties.expires).toLocaleString()}</p>
                    <p>${properties.description}</p>
                    ${properties.instruction ? `<p><a href="${properties.instruction}" target="_blank">Instructions</a></p>` : ''}
                </div>
            `;
        }

        function showInfoPanel(properties, latlng) {
            const infoPanel = document.getElementById('info-panel');
            infoPanel.innerHTML = `
                <h3>${properties.event}</h3>
                <p><strong>Area:</strong> ${properties.areaDesc}</p>
                <p><strong>Severity:</strong> ${properties.severity}</p>
                <p><strong>Effective:</strong> ${new Date(properties.effective).toLocaleString()}</p>
                <p><strong>Expires:</strong> ${new Date(properties.expires).toLocaleString()}</p>
                <p>${properties.headline || properties.description.substring(0, 100)}...</p>
            `;
            const point = map.latLngToContainerPoint(latlng);
            infoPanel.style.left = (point.x + 10) + 'px';
            infoPanel.style.top = (point.y + 10) + 'px';
            infoPanel.style.display = 'block';
        }

        function hideInfoPanel() {
            document.getElementById('info-panel').style.display = 'none';
        }

        function checkUserInAlertArea() {
            if (!userLocation || typeof userLocation.lat !== 'number' || typeof userLocation.lng !== 'number') {
                console.error('Invalid user location:', userLocation);
                return;
            }
            const banner = document.getElementById('alert-banner');
            let userInAlert = false;
            let highestSeverityAlert = null;
            for (const id in alertLayers) {
                const layer = alertLayers[id];
                if (layer && (layer instanceof L.Polygon || layer instanceof L.FeatureGroup)) {
                    try {
                        if (layer.getBounds().contains([userLocation.lat, userLocation.lng])) {
                            userInAlert = true;
                            const popupContent = layer.getPopup().getContent();
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(popupContent, 'text/html');
                            const eventType = doc.querySelector('h3').textContent;
                            const severity = doc.querySelector('p:nth-child(3)').textContent.replace('Severity: ', '');
                            if (!highestSeverityAlert) {
                                highestSeverityAlert = {id, eventType, severity};
                            } else if (severity === 'Extreme' && highestSeverityAlert.severity !== 'Extreme') {
                                highestSeverityAlert = {id, eventType, severity};
                            } else if (severity === 'Severe' && highestSeverityAlert.severity !== 'Extreme' && 
                                      highestSeverityAlert.severity !== 'Severe') {
                                highestSeverityAlert = {id, eventType, severity};
                            }
                        }
                    } catch (error) {
                        console.error('Error checking if user is in alert area:', error);
                    }
                }
            }
            if (userInAlert && highestSeverityAlert) {
                const alert = highestSeverityAlert;
                banner.innerHTML = `
                    <strong>${alert.eventType}</strong> is in effect for your location. 
                    <a href="#" onclick="focusOnAlert('${alert.id}')">View details</a>
                `;
                banner.classList.add('active');
            } else {
                banner.classList.remove('active');
            }
        }

        window.focusOnAlert = function(alertId) {
            const layer = alertLayers[alertId];
            if (layer) {
                if (layer.getBounds) map.fitBounds(layer.getBounds());
                layer.openPopup();
            }
        }

        const style = document.createElement('style');
        style.textContent = `
            .pulsing-layer {
                animation: pulse-animation 2s infinite;
            }
            @keyframes pulse-animation {
                0% { opacity: 0.7; }
                50% { opacity: 0.3; }
                100% { opacity: 0.7; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
